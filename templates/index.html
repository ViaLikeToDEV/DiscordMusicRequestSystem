<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div id="interaction-overlay" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#fff;display:flex;align-items:center;justify-content:center;">
      <button id="start-btn" style="font-size:2rem;padding:1em 2em;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
    </div>
    <h1>üéµ Music Player Control Panel</h1>
    
    <!-- Current Song Display -->
    <div id="current-song">
        <h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô:</h2>
        <div id="now-playing">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô</div>
        <audio id="audio-player" controls style="width: 100%; margin: 10px 0;"></audio>
    </div>
    
    <!-- Controls -->
    <div id="controls">
        <button onclick="skipSong()">‚è≠Ô∏è Skip</button>
        <button onclick="pauseSong()">‚è∏Ô∏è Pause</button>
        <button onclick="resumeSong()">‚ñ∂Ô∏è Resume</button>
        <br><br>
        <label for="volume-slider">üîä Volume: </label>
        <input type="range" id="volume-slider" min="0" max="100" value="50" onchange="setVolume(this.value)">
        <span id="volume-display">50%</span>
    </div>
    
    <!-- Add Song Form -->
    <div id="add-song-form">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á:</h3>
        <input type="text" id="youtube-url" placeholder="‡πÉ‡∏™‡πà YouTube URL ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" style="width: 400px;">
        <button onclick="addSong()">‚ûï Add Song</button>
    </div>
    
    <!-- Queue Display -->
    <div id="queue-section">
        <h3>‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á:</h3>
        <div id="queue-list">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß</div>
    </div>
    
    <!-- Status Messages -->
    <div id="messages" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; min-height: 100px; max-height: 200px; overflow-y: auto;">
        <h4>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</h4>
        <div id="status-messages"></div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Audio player element
        const audioPlayer = document.getElementById('audio-player');
        let currentSongId = null;
        
        // Socket event listeners
        socket.on('connect', function() {
            addStatusMessage('üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß');
        });
        
        socket.on('status_updated', function(data) {
            updateStatus(data);
        });
        
        socket.on('queue_updated', function(data) {
            updateStatus(data);
        });
        
        socket.on('skip', function() {
            audioPlayer.pause();
            loadNextSong();
        });
        
        socket.on('pause', function() {
            audioPlayer.pause();
        });
        
        socket.on('resume', function() {
            audioPlayer.play();
        });
        
        socket.on('volume_changed', function(data) {
            audioPlayer.volume = data.volume / 100;
            document.getElementById('volume-slider').value = data.volume;
            document.getElementById('volume-display').textContent = data.volume + '%';
        });
        
        socket.on('song_ready', function(data) {
            addStatusMessage(`‚úÖ ‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô: ${data.title}`);
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà ready ‡∏Ñ‡∏∑‡∏≠ current_song ‡πÅ‡∏•‡∏∞ is_playing
            fetch('/status')
                .then(response => response.json())
                .then(status => {
                    if (
                        status.current_song &&
                        status.current_song.id === data.id &&
                        status.is_playing &&
                        !status.is_paused
                    ) {
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï src ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        audioPlayer.src = `/audio/${data.id}`;
                        audioPlayer.load();
                        audioPlayer.play().catch(function(err) {
                            addStatusMessage('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà player ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° ‚ñ∂Ô∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á');
                        });
                        currentSongId = data.id;
                    }
                });
        });
        
        socket.on('download_error', function(data) {
            addStatusMessage(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏î‡πâ: ${data.error}`);
        });
        
        // Audio player events
        audioPlayer.addEventListener('ended', function() {
            // ‡πÅ‡∏à‡πâ‡∏á backend ‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            fetch('/song_ended', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.song) {
                        addStatusMessage(`üéµ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ: ${data.song.title}`);
                    } else {
                        addStatusMessage('üì≠ ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß');
                        // ‡∏•‡πâ‡∏≤‡∏á src ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏ô‡∏ã‡πâ‡∏≥
                        audioPlayer.src = '';
                        currentSongId = null;
                    }
                });
        });
        
        audioPlayer.addEventListener('error', function() {
            addStatusMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á');
            loadNextSong();
        });
        
        // Functions
        function updateStatus(data) {
            // Update current song display
            const nowPlaying = document.getElementById('now-playing');
            if (data.current_song) {
                nowPlaying.innerHTML = `<strong>${data.current_song.title}</strong>`;
                
                // Load audio if different song
                if (currentSongId !== data.current_song.id) {
                    currentSongId = data.current_song.id;
                    if (data.current_song.file_path) {
                        audioPlayer.src = `/audio/${data.current_song.id}`;
                        audioPlayer.load();
                        if (data.is_playing && !data.is_paused) {
                            // Try to autoplay
                            audioPlayer.play().catch(function(err) {
                                addStatusMessage('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà player ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° ‚ñ∂Ô∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á');
                            });
                        }
                    }
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏•‡πà‡∏ô
                    if (data.is_playing && !data.is_paused && audioPlayer.paused) {
                        audioPlayer.play().catch(function(err) {
                            addStatusMessage('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà player ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° ‚ñ∂Ô∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á');
                        });
                    }
                }
            } else {
                nowPlaying.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô';
                audioPlayer.src = '';
                currentSongId = null;
            }
            
            // Update queue display
            const queueList = document.getElementById('queue-list');
            if (data.queue && data.queue.length > 0) {
                let queueHtml = '<ol>';
                data.queue.forEach(function(song) {
                    queueHtml += `<li>${song.title}</li>`;
                });
                queueHtml += '</ol>';
                queueList.innerHTML = queueHtml;
            } else {
                queueList.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß';
            }
            
            // Update volume
            if (data.volume !== undefined) {
                audioPlayer.volume = data.volume / 100;
                document.getElementById('volume-slider').value = data.volume;
                document.getElementById('volume-display').textContent = data.volume + '%';
            }
        }
        
        function addSong() {
            const urlInput = document.getElementById('youtube-url');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà YouTube URL');
                return;
            }
            
            addStatusMessage(`‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ${url}`);
            
            fetch('/api/add_song', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addStatusMessage(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß: ${data.title}`);
                    urlInput.value = '';
                } else {
                    addStatusMessage(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error}`);
                }
            })
            .catch(error => {
                addStatusMessage(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            });
        }
        
        function skipSong() {
            fetch('/skip', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addStatusMessage('‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß');
                    }
                });
        }
        
        function pauseSong() {
            fetch('/pause', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addStatusMessage('‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß');
                    }
                });
        }
        
        function resumeSong() {
            fetch('/resume', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addStatusMessage('‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏ï‡πà‡∏≠');
                    }
                });
        }
        
        function setVolume(value) {
            fetch('/volume', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ volume: parseInt(value) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('volume-display').textContent = value + '%';
                    addStatusMessage(`üîä ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô ${value}%`);
                }
            });
        }
        
        function loadNextSong() {
            fetch('/next_song')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addStatusMessage(`üéµ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ: ${data.song.title}`);
                    } else {
                        addStatusMessage('üì≠ ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß');
                    }
                });
        }
        
        function addStatusMessage(message) {
            const statusMessages = document.getElementById('status-messages');
            const timestamp = new Date().toLocaleString('th-TH');
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<small>${timestamp}</small> - ${message}`;
            statusMessages.appendChild(messageDiv);
            statusMessages.scrollTop = statusMessages.scrollHeight;
        }
        
        // Handle Enter key in URL input
        document.getElementById('youtube-url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addSong();
            }
        });
        
        // Load initial status
        fetch('/status')
            .then(response => response.json())
            .then(data => updateStatus(data));
        
        // Overlay interaction unlock autoplay
        document.getElementById('start-btn').addEventListener('click', function() {
            document.getElementById('interaction-overlay').style.display = 'none';
            // Unlock autoplay by playing muted
            audioPlayer.muted = true;
            audioPlayer.play().catch(()=>{}).finally(()=>{
                audioPlayer.muted = false;
            });
        });
    </script>
</body>
</html>